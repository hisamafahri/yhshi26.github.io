<!DOCTYPE html>
<html>

<head>
    <title>8Bit Platformer</title>
    <style>
        canvas {
            top: 100px;
            left: 0px;
            border: none;
            z-index: 1;
            width: 660px;
            height: 460px;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            padding-top: 15px;
        }

        li {
            display: inline;
            padding-right: 10px;
            padding-left: 10px;
        }

        p {
            font-weight: bolder;
        }

        #game {
            display: block;
            text-align: center;
        }

        #details {
            display: block;
            text-align: center;
        }

        #all {
            text-align: center;
        }

        .bold {
            font-weight: bolder;
        }

        body {
            font-family: trebuchet ms;
        }
    </style>
</head>

<body>
    <div id="all">
        <div id="details">
            <p style="padding-top: 15px;"> How to play: 8Bit Platformer </p>
            <p> Avoid the pumpkins. Hearts restore lives! Press space to start/stop music. </p>
            <li> <span class="bold">Jump:</span> up arrow </li>
            <li> <span class="bold">Duck:</span> down arrow </li>
            <li> <span class="bold">Double jump:</span> tap up when in air </li>
        </div>
        <div id="game">
            <canvas id="background" width="538" height="392">
                    Your browser does not support canvas. Please try again with a different browser.
            </canvas>
        </div>
    </div>

    <script onload="init()">
        var upPressed = false;
        var downPressed = false;
        var status = 1;
        var goingUp = null;
        var inAir = false;
        var jumpAgain = false;
        var doubleJumped = false;
        var lock = true;
        var lives = 3;
        var lose = false;
        var score = 0;
        var music = new Audio ("hesapirate.mp3");
        var musicPlay = false;
        // Define an object to hold all our images for the game so images are only ever created once. This type of object is known as a singleton. 
        var imageRepository = new function() {
            // Define images
            this.background = new Image();
            this.land = new Image();

            this.normal = new Image();
            this.jump = new Image();
            this.duck = new Image();

            this.tree1 = new Image();
            this.tree2 = new Image();
            this.tree3 = new Image();
            this.bush = new Image();
            this.treeImages = new Array(4);

            this.pumpkin1 = new Image();
            this.pumpkin2 = new Image();
            this.pumpkin3 = new Image();
            this.pumpkinImages = new Array(3);

            this.hearts = new Image();
            // Ensure all images have loaded before starting the game
            var numImages = 6;
            var numLoaded = 0;

            function imageLoaded() {
                numLoaded++;
                if (numLoaded === numImages) {
                    imageRepository.treeImages[0] = imageRepository.tree1;
                    imageRepository.treeImages[1] = imageRepository.tree2;
                    imageRepository.treeImages[2] = imageRepository.tree3;
                    imageRepository.treeImages[3] = imageRepository.bush;
                    imageRepository.pumpkinImages[0] = imageRepository.pumpkin1;
                    imageRepository.pumpkinImages[1] = imageRepository.pumpkin2;
                    imageRepository.pumpkinImages[2] = imageRepository.pumpkin3;
                    window.init(); //so if num of loaded images = num of images, then continue
                }
            }
            this.background.onload = function() {
                imageLoaded();
            }
            this.normal.onload = function() {
                imageLoaded();
            }
            this.tree1.onload = function() {
                imageLoaded();
            }
            this.pumpkin1.onload = function() {
                imageLoaded();
            }
            this.land.onload = function() {
                imageLoaded();
            }
            this.hearts.onload = function() {
                imageLoaded();
            }

            // Set images src
            //background
            this.background.src = "images/panningb.png";
            //land
            this.land.src = "images/land.png";
            //character
            this.normal.src = "images/norm.png";
            this.jump.src = "images/up.png";
            this.duck.src = "images/squish.png";
            //trees
            this.tree1.src = "images/tree1.png";
            this.tree2.src = "images/tree2.png";
            this.tree3.src = "images/tree3.png";
            this.bush.src = "images/bush.png";
            //pumpkins
            this.pumpkin1.src = "images/pumpkin1.png";
            this.pumpkin2.src = "images/pumpkin2.png";
            this.pumpkin3.src = "images/pumpkin3.png";
            //hearts
            this.hearts.src = "images/heart.png";
        }

        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

        function keyDownHandler(e) {
            // key codes are basically to tell us which key is pressed
            if (e.keyCode == 38) {
                upPressed == true;
            } else if (e.keyCode == 40) {
                downPressed == true;
                status = 3;
            }
        }

        function keyUpHandler(e) {
            if (e.keyCode == 38) {
                upPressed == false;
                if (inAir && !doubleJumped) {
                    jumpAgain = true;
                }
                status = 2;
                goingUp = true;
            } else if (e.keyCode == 40) {
                downPressed == false;
                status = 1;
            } else if (e.keyCode == 32) {
                if (musicPlay == true) {
                    music.pause();
                    musicPlay = false;
                }
                else if (musicPlay == false) {
                    music.play();
                    musicPlay = true;
                }
                console.log (musicPlay);
            }
        }

        function Drawable() {
            this.init = function(x, y) {
                // Default variables
                this.x = x;
                this.y = y;
            }
            this.speed = 0;
            this.accelFactor = 0;
            this.accelSpeed = 1;
            this.canvasWidth = 0;
            this.canvasHeight = 0;
            this.counter = 0;
            // Define abstract function to be implemented in child objects
            this.draw = function() {};
        }

        function Background() {
            this.speed = 1; // Redefine speed of the background for panning
            this.accelFactor = 0.025;
            this.counter = 0;
            this.accelSpeed = 0.0625;
            // Implement abstract function
            this.draw = function() {
                // Pan background
                this.x -= this.speed;
                this.counter += 1;
                if (this.counter % this.accelSpeed == 0)
                    this.speed += this.accelFactor;

                this.context.drawImage(imageRepository.background, this.x, this.y);
                // Draw another image at the side of the first image
                this.context.drawImage(imageRepository.background, this.x - this.canvasWidth, this.y);
                // If the image scrolled off the screen, reset
                if (this.x <= 0)
                    this.x = this.canvasWidth;
                if (this.speed >= 5) {
                    this.accelFactor = 0;
                    this.speed = 5;
                }
            };
        }
        // Set Background to inherit properties from Drawable
        Background.prototype = new Drawable();

        function Land() {
            this.speed = 1.5; // Redefine speed of the background for panning
            this.accelFactor = 0.025;
            this.counter = 0;
            this.accelSpeed = 0.0625;
            // Implement abstract function
            this.draw = function() {
                // Pan background
                this.x -= this.speed;
                this.counter += 1;
                if (this.counter % this.accelSpeed == 0)
                    this.speed += this.accelFactor;

                this.context.drawImage(imageRepository.land, this.x, this.y, 550, 150);
                // Draw another image at the side of the first image
                this.context.drawImage(imageRepository.land, this.x - this.canvasWidth, this.y, 550, 150);
                // If the image scrolled off the screen, reset
                if (this.x <= 0)
                    this.x = this.canvasWidth;
                if (this.speed >= 5.5) {
                    this.accelFactor = 0;
                    this.speed = 5.5;
                }
            };
        }
        Land.prototype = new Drawable();

        function treesGenerator() {
            this.speed = 1.2; // Redefine panning speed
            this.accelFactor = 0.025;
            this.counter = 0;
            this.accelSpeed = 0.0625;
            this.treeImage = imageRepository.treeImages[Math.floor(Math.random() * 4)];
            // Implement abstract function
            this.draw = function() {
                // Pan 
                this.x -= this.speed;
                this.y = 182.5;
                this.counter += 1;
                if (this.counter % this.accelSpeed == 0)
                    this.speed += this.accelFactor;

                this.context.drawImage(this.treeImage, this.x, this.y, 50.96, 74.48);
                // Draw another image at the side of the first image
                //this.context.drawImage(this.treeImage, this.x - this.canvasWidth, this.y, 50.96, 74.48);
                // If the image scrolled off the screen, reset
                if (this.x < 0) {
                    this.x = Math.random() * 4000 + this.canvasWidth;
                    this.treeImage = imageRepository.treeImages[Math.floor(Math.random() * 4)];
                }
                if (this.speed >= 5) {
                    this.accelFactor = 0;
                    this.speed = 5;
                }
            };
        }
        // Set to inherit properties from Drawable
        treesGenerator.prototype = new Drawable();

        function Character() {
            this.jumpSpeed = 10;
            this.accelFactor = 0.1;
            this.counter = 0;
            this.gravity = 0.75;
            // Implement abstract function
            this.draw = function() {
                var originalY = 240;
                var maxHeight = 170;

                if (status == 1) {
                    //normal
                    this.context.drawImage(imageRepository.normal, this.x, this.y, 26.25, 16);
                } else if (status == 2) {
                    //jump 
                    this.context.drawImage(imageRepository.jump, this.x, this.y, 26.25, 18.75);
                    this.y -= this.jumpSpeed;
                    this.jumpSpeed -= this.gravity;
                    inAir = true;

                    if (jumpAgain && lock) {
                        this.jumpSpeed = 5;
                        doubleJumped = true;
                        lock = false;
                        //jumpAgain = false;
                    }

                    if (this.y > originalY) {
                        status = 1;
                        this.y = originalY;
                        this.jumpSpeed = 11;
                        doubleJumped = false;
                        lock = true;
                        jumpAgain = false;
                        inAir = false;
                        //this.accel = -this.accel;
                    }
                } else if (status == 3) {
                    //duck
                    if (this.y == originalY) {
                        this.context.drawImage(imageRepository.duck, this.x, this.y, 26.25, 15);
                    } else if (this.y <= originalY) {
                        this.jumpSpeed = 7;
                        this.y += this.jumpSpeed;
                        //this.jumpSpeed += this.gravity;
                        this.context.drawImage(imageRepository.duck, this.x, this.y, 26.25, 15);
                        if (this.y > originalY) {
                            this.jumpSpeed = 10;
                            this.y = originalY;
                        }
                    }

                }
            };
        }
        Character.prototype = new Drawable();

        function pumpkinsGenerator() {
            this.speed = 1.7; // Redefine panning speed
            this.accelFactor = 0.025;
            this.counter = 0;
            this.accelSpeed = 0.0625;
            this.pumpkinImage = imageRepository.pumpkinImages[Math.floor(Math.random() * 3)];
            // Implement abstract function
            this.draw = function() {
                // Pan 
                this.x -= this.speed;
                this.y = 221;
                this.counter += 1;
                if (this.counter % this.accelSpeed == 0)
                    this.speed += this.accelFactor;

                this.context.drawImage(this.pumpkinImage, this.x, this.y, 35, 35);
                // Draw another image at the side of the first image
                //this.context.drawImage(this.pumpkinImage, this.x - this.canvasWidth*1.5, this.y, 35, 35);
                // If the image scrolled off the screen, reset
                if (this.x < 0) {
                    this.x = Math.random() * 2000 + this.canvasWidth;
                    this.pumpkinImage = imageRepository.pumpkinImages[Math.floor(Math.random() * 3)];
                }
                if (this.speed >= 5.5) {
                    this.accelFactor = 0;
                    this.speed = 5.5;
                }
            };
        }
        pumpkinsGenerator.prototype = new Drawable();

        function heartsGenerator() {
            this.speed = 1.7; // Redefine panning speed
            this.accelFactor = 0.025;
            this.counter = 0;
            this.accelSpeed = 0.0625;
            this.heartImage = imageRepository.hearts;
            // Implement abstract function
            this.draw = function() {
            // Pan 
            this.x -= this.speed;
            this.y = 167;
            this.counter += 1;
                if (this.counter % this.accelSpeed == 0)
                    this.speed += this.accelFactor;

                this.context.drawImage(imageRepository.hearts, this.x, this.y, 20, 20);
                // Draw another image at the side of the first image
               // this.context.drawImage(imageRepository.hearts, this.x - this.canvasWidth, this.y, 20, 20);
                // If the image scrolled off the screen, reset
                if (this.x < 0) {
                    this.x = Math.random() * 6000 + this.canvasWidth;
                }
                if (this.speed >= 5.5) {
                    this.accelFactor = 0;
                    this.speed = 5.5;
                }
            };
        }
        heartsGenerator.prototype = new Drawable();

        function drawLives() {
            var context = game.bgCanvas.getContext('2d');
            var width = game.bgCanvas.width;
            context.font = "18px trebuchet ms";
            context.fillStyle = "#ffffff";
            context.fillText("Lives: "+lives, width-80, 25);
        }

        function drawScore() {
            if (!lose) {
                score++;
            }            
            var context = game.bgCanvas.getContext('2d');
            context.font = "18px trebuchet ms";
            context.fillStyle = "#ffffff";
            context.fillText("Score: "+ score, 10, 25);
        }

        function collisionDetection() {
            for (var a = 0; a < 4; a++) {
                if (game.character.x < game.pumpkins[a].x + 35 && game.character.x + 26.25 > game.pumpkins[a].x && game.character.y < game.pumpkins[a].y + 35 && 18.75 + game.character.y > game.pumpkins[a].y){
                    lives--;
                    game.pumpkins[a].x = Math.random() * 4900 + game.pumpkins[a].canvasWidth;
                    console.log(lives);
                }
            }
            for (var q = 0; q < 1; q++) {
                if (game.character.x < game.hearts[q].x + 20 && game.character.x + 26.25 > game.hearts[q].x && game.character.y < game.hearts[q].y + 20 && 18.75 + game.character.y > game.hearts[q].y){
                    lives++;
                    game.hearts[q].x = Math.random() * 4900 + game.hearts[q].canvasWidth;
                }
            }
            if (lives <= 0) {
                lose = true;
                gameOver();
            }
            else if (lives > 0) {
                lose = false;
            }
        }

        function gameOver() {
            if (lose) {
                alert("Game over... :( Your score is: " + score);
                document.location.reload();
                lives = 3;
                music.pause();
            }
            //fix this! once it works make sure it doesn't keep bringing the pop up! Make sure u can close the pop up!!!!!!!!!!!
        }

        function Game() {
            this.bgCanvas;
            this.init = function() {
                // Get the canvas element
                this.bgCanvas = document.getElementById('background');
                // Test to see if canvas is supported
                if (this.bgCanvas.getContext) {
                    this.bgContext = this.bgCanvas.getContext('2d');
                    // Initialize objects to contain their context and canvas
                    // information
                    Background.prototype.context = this.bgContext;
                    Background.prototype.canvasWidth = this.bgCanvas.width;
                    Background.prototype.canvasHeight = this.bgCanvas.height;

                    Land.prototype.context = this.bgContext;
                    Land.prototype.canvasWidth = this.bgCanvas.width;
                    Land.prototype.canvasHeight = this.bgCanvas.height;

                    Character.prototype.context = this.bgContext;

                    treesGenerator.prototype.context = this.bgContext;
                    treesGenerator.prototype.canvasWidth = this.bgCanvas.width;
                    treesGenerator.prototype.canvasHeight = this.bgCanvas.height;

                    pumpkinsGenerator.prototype.context = this.bgContext;
                    pumpkinsGenerator.prototype.canvasWidth = this.bgCanvas.width;
                    pumpkinsGenerator.prototype.canvasHeight = this.bgCanvas.height;

                    heartsGenerator.prototype.context = this.bgContext;
                    heartsGenerator.prototype.canvasWidth = this.bgCanvas.width;
                    heartsGenerator.prototype.canvasHeight = this.bgCanvas.height;

                    // Initialize the object
                    this.background = new Background();
                    this.background.init(0, 0); // Set draw point

                    this.land = new Land();
                    this.land.init(0, 256); 

                    this.character = new Character();
                    this.character.init(45, 240);

                        this.hearts = new Array(1);
                        for (var q = 0; q < this.hearts.length; q++) {
                            this.hearts[q] = new heartsGenerator();
                            this.hearts[q].init(0,100);
                        }

                        this.trees = new Array(5);
                        for (var i = 0; i < this.trees.length; i++) {
                            this.trees[i] = new treesGenerator();
                            this.trees[i].init(0, 240);
                        }

                        this.pumpkins = new Array(4);
                        for (var a = 0; a < this.pumpkins.length; a++) {
                            this.pumpkins[a] = new pumpkinsGenerator();
                            this.pumpkins[a].init(0, 240);
                        }
                        return true;
                    } else {
                        return false;
                    }
                };
                // Start the animation loop
                this.start = function() {
                    animate();
                };
            }

            function animate() {
                requestAnimFrame(animate);
                game.background.draw();
                for (var i = 0; i < 5; i++) {
                    game.trees[i].draw();
                }
                game.land.draw();
                for (var a = 0; a < 4; a++) {
                    game.pumpkins[a].draw();
                }
                for (var q = 0; q < 1; q++) {
                    game.hearts[q].draw();
                }
                game.character.draw();
                collisionDetection();
                drawScore();
                drawLives();

            }

            var requestAnimFrame = (function() {
                return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    function(callback, element) {
                        window.setTimeout(callback, 1000 / 60);
                    };
            })();

            var game = new Game();

            function init() {
                if (game.init())
                    game.start();
            }

    </script>
</body>

</html>